pipeline {
  agent any

  environment {
    REGISTRY  = 'https://index.docker.io/v1/'
    IMAGE_REPO = 'nhhnam/mangahub-backend' 
    DOCKER_CREDS = credentials('docker_hub_credentials') // ID của Docker Hub credentials trong Jenkins
    // Tag theo short SHA + 'latest'
    GIT_SHORT = sh(script: "echo ${env.GIT_COMMIT} | cut -c1-7", returnStdout: true).trim()
  }

  options {
    timestamps()
  }

  stages {
    stage('Checkout') {
      steps {
        checkout scm
      }
    }

    stage('Build image') {
      steps {
        script {
          // Nếu build trên ARM nhưng deploy x86_64, thêm --platform=linux/amd64
          sh "docker build -t ${IMAGE_REPO}:${GIT_SHORT} ."
          sh "docker tag ${IMAGE_REPO}:${GIT_SHORT} ${IMAGE_REPO}:latest"
        }
      }
    }

    stage('Push to Docker Hub') {
      steps {
        script {
          docker.withRegistry(REGISTRY, 'docker_hub_credentials') {
            sh "docker push ${IMAGE_REPO}:${GIT_SHORT}"
            sh "docker push ${IMAGE_REPO}:latest"
          }
        }
      }
    }

    stage('Deploy with Docker Compose') {
      steps {
        script {
          def appName = "mangahub-backend"
          sh """
            set -e
            docker pull ${IMAGE_REPO}:latest
            docker rm -f ${appName} || true
            cd ~/mangahub
            docker compose --env-file .env.production -f docker-compose-vps.yml up -d
          """
        }
      }
    }
  }

  post {
    always {
      cleanWs()
    }
  }
}
